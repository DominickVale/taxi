import t from"@unseenco/e";const e=new DOMParser;function n(t){const e=new URL(t,window.location.origin);let n=null;return e.hash.length&&(n=t.replace(e.hash,"")),{hasHash:e.hash.length>0,pathname:e.pathname,raw:t,href:n||e.href}}function r(t){"HEAD"===t.parentNode.tagName?document.head.appendChild(i(t)):document.body.appendChild(i(t))}function i(t){const e=document.createElement("SCRIPT");for(let n=0;n<t.attributes.length;n++){const r=t.attributes[n];e.setAttribute(r.nodeName,r.nodeValue)}return t.innerHTML&&(e.innerHTML=t.innerHTML),e}class a{constructor(){this.data=new Map,this.regexCache=new Map}add(t,e,n){this.data.has(t)||(this.data.set(t,new Map),this.regexCache.set(t,new RegExp(`^${t}$`))),this.data.get(t).set(e,n),this.regexCache.set(e,new RegExp(`^${e}$`))}findMatch(t,e){for(const[n,r]of this.data)if(t.pathname.match(this.regexCache.get(n))){for(const[t,n]of r)if(e.pathname.match(this.regexCache.get(t)))return n;break}return null}}class o{constructor(t={}){this.isTransitioning=!1,this.currentView=null,this.cache=new Map,this.onClick=t=>{if(!t.metaKey&&!t.ctrlKey){const e=n(t.currentTarget.href);if(this.currentLocation=n(window.location.href),this.currentLocation.href!==e.href||this.currentLocation.hasHash&&!e.hasHash)return t.preventDefault(),void this.navigate(e.raw,t.currentTarget.dataset.taxiTransition||!1,t.currentTarget);this.currentLocation.hasHash||e.hasHash||t.preventDefault()}},this.onPopstate=()=>window.location.pathname!==this.currentLocation.pathname&&(this.isTransitioning?(window.history.pushState({},"",this.currentLocation.href),!1):void this.navigate(window.location.href,!1,"popstate"));const{links:e="a:not([target]):not([href^=\\#]):not([data-taxi-ignore])",views:r={default:c},transitions:i={default:h},reloadJsFilter:a=function(t){return!("__bs_script__"===(null==t?void 0:t.id)||null!=t&&t.src.includes("browser-sync-client.js"))}}=t;this.views=r,this.transitions=i,this.defaultView=this.views.default||c,this.defaultTransition=this.transitions.default||h,this.wrapper=document.querySelector("[data-taxi]"),this.reloadJsFilter=a,this.cache=new Map,this.attachEvents(e),this.currentLocation=n(window.location.href),this.cache.set(this.currentLocation.href,this.createCacheEntry(document.cloneNode(!0))),this.currentView=this.cache.get(this.currentLocation.href),this.currentView.view.initialLoad()}setDefaultView(t){this.defaultView=this.views[t]}setDefaultTransition(t){this.defaultTransition=this.transitions[t]}addRoute(t,e,n){this.router||(this.router=new a),this.router.add(t,e,n)}preload(t){var e=this;return t=n(t).href,this.cache.has(t)||this.fetch(t).then(async function(n){e.cache.set(t,e.createCacheEntry(n))}),this}navigate(t,e=!1,r=!1){var i=this;return this.targetLocation=n(t),new Promise((t,n)=>{if(this.isTransitioning)return void n(new Error("A transition is currently in progress"));const a=new(this.chooseTransition(e))({wrapper:this.wrapper});this.beforeFetch(this.targetLocation,a,r).then(async function(){return i.cache.has(i.targetLocation.href)?await i.afterFetch(i.targetLocation,a,i.cache.get(i.targetLocation.href),r):i.fetch(i.targetLocation.raw).then(async function(t){return await i.afterFetch(i.targetLocation,a,i.createCacheEntry(t),r)})}).then(()=>{t()})})}beforeFetch(e,n,r){return this.isTransitioning=!0,console.log("NAVIGATE_OUT"),t.emit("NAVIGATE_OUT",{from:this.currentView,trigger:r}),new Promise(t=>{this.currentView.view.leave(n,r).then(()=>{"popstate"!==r&&window.history.pushState({},"",e.raw),t()})})}afterFetch(e,n,r,i){return this.cache.has(e.href)||this.cache.set(e.href,r),this.currentLocation=e,console.log("NAVIGATE_IN"),t.emit("NAVIGATE_IN",{from:this.currentView,to:r,trigger:i}),new Promise(e=>{r.view.update(),this.loadScripts(r.scripts),r.view.enter(n,i).then(()=>{console.log("NAVIGATE_COMPLETE",this.cache),t.emit("NAVIGATE_COMPLETE",{from:this.currentView,to:r,trigger:i}),this.currentView=r,this.isTransitioning=!1,e()})})}loadScripts(t){const e=[...t],n=[...document.querySelectorAll("script:not([data-no-reload])")].filter(this.reloadJsFilter);for(let t=0;t<n.length;t++)for(let r=0;r<e.length;r++)if(n[t].outerHTML===e[r].outerHTML){(a=n[t]).parentNode.replaceChild(i(a),a),e.splice(r,1);break}var a;for(const t of e)r(t)}attachEvents(e){t.delegate("click",e,this.onClick),t.on("popstate",window,this.onPopstate)}fetch(t){return new Promise(n=>{fetch(t,{mode:"same-origin",method:"GET",headers:{"X-Requested-With":"Taxi"},credentials:"same-origin"}).then(e=>(e.ok||(console.warn("Taxi encountered a non 2xx HTTP status code"),window.location.href=t),e.text())).then(t=>{var r;n("string"==typeof(r=t)?e.parseFromString(r,"text/html"):r)}).catch(e=>{console.warn(e),window.location.href=t})})}chooseTransition(t){var e;if(t)return this.transitions[t];const n=null==(e=this.router)?void 0:e.findMatch(this.currentLocation,this.targetLocation);return n?this.transitions[n]:this.defaultTransition}createCacheEntry(t){const e=t.querySelector("[data-taxi-view]"),n=e.dataset.taxiView.length?this.views[e.dataset.taxiView]:this.defaultView;return{page:t,content:e,scripts:[...t.querySelectorAll("script:not([data-no-reload])")].filter(this.reloadJsFilter),title:t.title,view:new n({wrapper:this.wrapper,title:t.title,content:e,page:t})}}}function s(){return s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},s.apply(this,arguments)}class h{constructor({wrapper:t}){this.wrapper=t}leave(t){return new Promise(e=>{this.onLeave(s({},t,{done:e}))})}enter(t){return new Promise(e=>{this.onEnter(s({},t,{done:e}))})}onLeave({done:t}){t()}onEnter({done:t}){t()}}class c{constructor({content:t,page:e,title:n,wrapper:r}){this.content=t,this.page=e,this.title=n,this.wrapper=r}onEnter(){}onEnterCompleted(){}onLeave(){}onLeaveCompleted(){}initialLoad(){this.onEnter(),this.onEnterCompleted()}update(){document.title=this.title,this.wrapper.insertAdjacentHTML("beforeend",this.content.outerHTML)}remove(){this.wrapper.firstElementChild.remove()}enter(t,e){return new Promise(n=>{this.onEnter(),t.enter({trigger:e,to:this.content}).then(()=>{this.onEnterCompleted(),n()})})}leave(t,e){return new Promise(n=>{this.onLeave(),t.leave({trigger:e,from:this.content}).then(()=>{this.remove(),this.onLeaveCompleted(),n()})})}}export{o as Core,h as Transition,c as View};
//# sourceMappingURL=taxi.modern.js.map
